<!DOCTYPE html>
<html lang="en">

<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <title>Student Project Details</title>
    <link rel="stylesheet" href="https://cdnjs.cloudflare.com/ajax/libs/font-awesome/6.4.0/css/all.min.css">
    <style>
        @import url('https://fonts.googleapis.com/css2?family=Poppins:ital,wght@0,100;0,200;0,300;0,400;0,500;0,600;0,700;0,800;0,900;1,100;1,200;1,300;1,400;1,500;1,600;1,700;1,800;1,900&display=swap');

        * {
            margin: 0;
            padding: 0;
            box-sizing: border-box;
            font-family: 'Poppins', sans-serif;
        }

        body {
            background-color: #f0f7ff;
            overflow-x: hidden;
        }

        main {
            display: flex;
            min-height: 100vh;
            position: relative;
        }

        .sidebar {
            width: 250px;
            height: 100vh;
            background-color: #2980b9;
            color: white;
            padding: 20px;
            position: sticky;
            top: 0;
            left: 0;
            display: flex;
            flex-direction: column;
            box-shadow: 2px 0 8px rgba(0, 0, 0, 0.1);
            transition: all 0.3s ease;
            z-index: 1000;
        }

        .sidebar.collapsed {
            width: 60px;
            padding: 20px 10px;
        }

        .toggle-sidebar {
            position: absolute;
            top: 10px;
            right: 10px;
            background: none;
            border: none;
            color: white;
            font-size: 20px;
            cursor: pointer;
            display: none;
        }

        .sidebar-user {
            text-align: center;
            margin-bottom: 2em;
        }

        .sidebar-user-icon {
            font-size: 40px;
            margin-bottom: 10px;
        }

        .sidebar-user-name {
            font-size: 16px;
            white-space: nowrap;
            overflow: hidden;
            text-overflow: ellipsis;
        }

        .sidebar-nav {
            flex: 1;
        }

        .sidebar-nav-link {
            display: flex;
            align-items: center;
            color: white;
            text-decoration: none;
            padding: 12px;
            margin: 8px 0;
            border-radius: 6px;
            transition: all 0.3s;
            white-space: nowrap;
            overflow: hidden;
        }

        .sidebar-nav-link i {
            margin-right: 12px;
            min-width: 20px;
            text-align: center;
            font-size: 18px;
        }

        .sidebar-nav-link span {
            font-size: 14px;
        }

        .sidebar-nav-link:hover {
            background-color: #3498db;
            transform: translateX(5px);
        }

        .sidebar-nav-link.active {
            background-color: #1a5276;
        }

        .sidebar-logout {
            margin-top: auto;
        }

        .sidebar-logout-button {
            width: 100%;
            padding: 12px;
            background-color: #e74c3c;
            color: white;
            border: none;
            border-radius: 6px;
            cursor: pointer;
            transition: background-color 0.3s;
            display: flex;
            align-items: center;
            justify-content: center;
        }

        .sidebar-logout-button i {
            margin-right: 8px;
        }


        .sidebar-logout-button:hover {
            background-color: #c0392b;
        }

        .sidebar.collapsed .sidebar-user-name,
        .sidebar.collapsed .sidebar-nav-link span,
        .sidebar.collapsed .sidebar-logout-button span {
            display: none;
        }

        section {
            flex: 1;
            padding: 25px 30px;
            margin-left: 20px;
            max-width: calc(100% - 270px);
            position: relative;
        }

        .mobile-menu-toggle {
            display: none;
            position: fixed;
            top: 15px;
            left: 15px;
            z-index: 1001;
            background-color: #2980b9;
            color: white;
            border: none;
            border-radius: 8px;
            width: 45px;
            height: 45px;
            font-size: 22px;
            cursor: pointer;
        }

        header {
            display: flex;
            justify-content: space-between;
            align-items: center;
            margin-bottom: 20px;
        }

        h1 {
            color: #2c3e50;
            font-size: 26px;
            font-weight: 600;
        }

        #back-btn,
        #add-task-btn,
        #edit-task-btn {
            padding: 10px 20px;
            background: #2980b9;
            color: white;
            border: none;
            border-radius: 6px;
            cursor: pointer;
            transition: background 0.3s;
        }

        #back-btn:hover,
        #add-task-btn:hover,
        #edit-task-btn:hover {
            background: #39a0e4;
        }

        .project-card {
            background: white;
            padding: 25px;
            border-radius: 12px;
            box-shadow: 0 4px 15px rgba(0, 0, 0, 0.08);
            margin-bottom: 30px;
        }

        .project-card h2 {
            color: #2980b9;
            margin-bottom: 20px;
            font-size: 22px;
            border-bottom: 2px solid #eee;
            padding-bottom: 10px;
        }

        .detail-grid {
            display: grid;
            grid-template-columns: repeat(auto-fit, minmax(280px, 1fr));
            gap: 20px;
            margin-top: 15px;
        }

        .detail-item {
            padding: 20px;
            background: #f8f9fa;
            border-radius: 10px;
            border-left: 4px solid #2980b9;
            transition: transform 0.2s;
        }

        .detail-item:hover {
            transform: translateY(-3px);
        }

        .detail-item h3 {
            color: #2c3e50;
            font-size: 16px;
            margin-bottom: 10px;
            font-weight: 600;
        }

        .detail-item p {
            color: #555;
            font-size: 14px;
            line-height: 1.6;
        }

        .task-management {
            display: flex;
            justify-content: space-between;
            align-items: center;
            margin-bottom: 20px;
        }

        .update-task {
            display: flex;
            gap: 20px;
        }

        .due-date {
            color: #e74c3c;
            font-weight: 600;
            font-size: 15px;
        }

        .status-indicator {
            display: inline-block;
            padding: 4px 12px;
            border-radius: 20px;
            font-size: 12px;
            font-weight: 500;
        }

        .status-completed {
            background: #27ae6020;

        }

        .status-inprogress {
            background: #f1c40f20;
        }

        .status-pending {
            background: #e74c3c20;

        }

        /* Tasks Layout Styles */
        .modal {
            display: none;
            position: fixed;
            z-index: 1000;
            left: 0;
            top: 0;
            width: 100%;
            height: 100%;
            overflow: auto;
            background-color: rgba(0, 0, 0, 0.5);
            justify-content: center;
            align-items: center;
        }

        .modal-content {
            background-color: #fff;
            padding: 20px;
            border-radius: 8px;
            width: 90%;
            max-width: 500px;
            box-shadow: 0 4px 15px rgba(0, 0, 0, 0.2);
            position: relative;
        }

        .close-modal {
            position: absolute;
            top: 10px;
            right: 10px;
            font-size: 20px;
            cursor: pointer;
            color: #555;
        }

        .form-group {
            margin-bottom: 15px;
        }

        .form-group label {
            display: block;
            margin-bottom: 5px;
            font-weight: 600;
            color: #333;
        }

        .form-group input,
        .form-group textarea,
        .form-group select {
            width: 100%;
            padding: 10px;
            border: 1px solid #ccc;
            border-radius: 6px;
            font-size: 14px;
        }

        .form-actions {
            display: flex;
            justify-content: space-between;
            gap: 10px;
        }

        .form-actions button {
            padding: 10px 20px;
            border: none;
            border-radius: 6px;
            cursor: pointer;
            font-size: 14px;
        }

        #save-task-btn {
            background-color: #2980b9;
            color: white;
        }

        #save-task-btn:hover {
            background-color: #39a0e4;
        }

        #cancel-task-btn {
            background-color: #e74c3c;
            color: white;
        }

        #cancel-task-btn:hover {
            background-color: #c0392b;
        }

        .task-columns {
            display: grid;
            grid-template-columns: repeat(auto-fit, minmax(300px, 1fr));
            gap: 25px;
            margin-top: 20px;
        }

        .task-column {
            background: #ffffff;
            border-radius: 12px;
            padding: 20px;
            box-shadow: 0 4px 15px rgba(0, 0, 0, 0.08);
        }

        .task-column h2 {
            color: #2980b9;
            font-size: 18px;
            margin-bottom: 20px;
            padding-bottom: 10px;
            border-bottom: 2px solid #eee;
        }

        .task-card {
            background: #f8f9fa;
            border-radius: 8px;
            padding: 15px;
            margin-bottom: 50px;
            border-left: 4px solid;
            transition: transform 0.2s;
            cursor: pointer;
        }

        .task-card:hover {
            transform: translateY(-3px);
        }

        .task-header {
            display: flex;
            justify-content: space-between;
            align-items: center;
            margin-bottom: 10px;
        }

        .assigned-member {
            display: flex;
            align-items: center;
            gap: 8px;
            font-weight: 500;
            color: #2c3e50;
        }

        .member-icon {
            width: 30px;
            height: 30px;
            border-radius: 50%;
            background: #2980b9;
            color: white;
            display: flex;
            align-items: center;
            justify-content: center;
            font-size: 14px;
        }

        .task-title {
            font-size: 16px;
            font-weight: 600;
            color: #2c3e50;
            margin-bottom: 8px;
        }

        .task-description {
            font-size: 14px;
            color: #555;
            margin-bottom: 12px;
            line-height: 1.5;
        }

        .task-meta span {
            margin-bottom: 30px;
        }

        .task-details {
            display: flex;
            justify-content: space-between;
            align-items: center;
        }

        .task-due-date {
            font-size: 13px;
            color: #e74c3c;
            font-weight: 500;
        }

        .task-status {
            display: inline-block;
            padding: 4px 12px;
            border-radius: 20px;
            font-size: 12px;
            font-weight: 500;
            text-transform: uppercase;
        }

        .task-column {
            margin-bottom: 20px;
        }


        /* Status Colors */
        .status-pending {
            border-color: #e74c3c;
        }

        .status-inprogress {
            border-color: #f1c40f;
        }

        .status-completed {
            border-color: #27ae60;
        }

        .status-pending .task-status {
            background: #e74c3c20;
            color: #e74c3c;
        }

        .status-inprogress .task-status {
            background: #f1c40f20;
            color: #f1c40f;
        }

        .status-completed .task-status {
            background: #27ae6020;
            color: #27ae60;
        }

        .task-actions {
            display: flex;
            gap: 10px;
        }

        .task-actions button {
            padding: 8px 12px;
            border: none;
            border-radius: 6px;
            cursor: pointer;
            font-size: 14px;
        }

        .edit-task-btn {
            background: #2980b9;
            color: white;
        }

        .edit-task-btn:hover {
            background: #39a0e4;
        }

        .delete-task-btn {
            background: #e74c3c;
            color: white;
        }

        .delete-task-btn:hover {
            background: #c0392b;
        }

        .files-container {
            margin-top: 30px;
        }

        .files-container h2 {
            color: #2980b9;
            font-size: 20px;
            margin-bottom: 15px;
        }

        table {
            width: 100%;
            border-collapse: collapse;
            margin-bottom: 20px;
        }

        table th,
        table td {
            padding: 10px;
            text-align: left;
            border: 1px solid #ddd;
        }

        table th {
            background-color: #2980b9;
            color: white;
        }

        table tr:nth-child(even) {
            background-color: #f2f2f2;
        }

        table tr:hover {
            background-color: #ddd;
        }

        .upload-new {
            padding: 10px 20px;
            background-color: #2980b9;
            /* Same as other buttons */
            color: white;
            border: none;
            border-radius: 6px;
            cursor: pointer;
            font-size: 14px;
            display: inline-flex;
            align-items: center;
            gap: 8px;
            /* Space between icon and text */
            transition: background-color 0.3s ease;
            text-decoration: none;
            /* Remove underline for links */
        }

        .upload-new i {
            font-size: 16px;
            /* Icon size */
        }

        .upload-new:hover {
            background-color: #39a0e4;
            /* Hover effect */
        }

        @media (max-width: 768px) {
            .sidebar {
                position: fixed;
                left: -250px;
                z-index: 1000;
            }

            .sidebar.open {
                left: 0;
            }

            .mobile-menu-toggle {
                display: block;
            }

            section {
                width: 100%;
                padding: 20px;
                margin-left: 0;
                max-width: 100%;
            }

            h1 {
                font-size: 24px;
                margin-top: 15px;
            }


        }

        @media (max-width: 480px) {
            .project-card {
                padding: 18px;
            }

            .detail-item {
                padding: 15px;
            }

            .detail-item h3 {
                font-size: 15px;
            }

            .detail-item p {
                font-size: 13px;
            }

            .task-column {
                padding: 15px;
            }

            .task-card {
                padding: 12px;
            }

            .task-title {
                font-size: 15px;
            }

            .task-description {
                font-size: 13px;
            }


        }
    </style>
</head>

<body>
    <button class="mobile-menu-toggle" id="mobile-menu-toggle">
        <i class="fas fa-bars"></i>
    </button>

    <main>
        <nav>
            <div class="sidebar" id="sidebar">
                <button class="toggle-sidebar" id="toggle-sidebar">
                    <i class="fas fa-chevron-left" id="toggle-icon"></i>
                </button>
                <div class="sidebar-user">
                    <div class="sidebar-user-icon">üë®‚Äçüéì</div>
                    <div class="sidebar-user-name" id="user-name">[User Name]</div>
                </div>
                <div class="sidebar-nav">
                    <a href="./ProjectList.html" class="sidebar-nav-link active">
                        <i class="fas fa-project-diagram"></i>
                        <span>Project List</span>
                    </a>
                    <a href="./Chat.html" class="sidebar-nav-link">
                        <i class="fas fa-comments"></i>
                        <span>Group Chat</span>
                    </a>

                    <a href="./Notifications.html" class="sidebar-nav-link">
                        <i class="fas fa-bell"></i>
                        <span>Notifications</span>
                    </a>
                </div>
                <div class="sidebar-logout">
                    <button class="sidebar-logout-button">
                        <i class="fas fa-sign-out-alt"></i>
                        <span>Logout</span>
                    </button>
                </div>
            </div>
        </nav>

        <section>
            <header>
                <h1>Project Overview</h1>
                <button id="back-btn" type="button">Back to Project List</button>
            </header>

            <div class="project-card">
                <h2 id="project-title">[Project Title]</h2>
                <div class="detail-grid">
                    <div class="detail-item">
                        <h3>Project Description</h3>
                        <p id="project-description">[Project Description]</p>
                    </div>
                    <div class="detail-item">
                        <h3>Assigned Group</h3>
                        <p id="assigned-group">[Assigned Group]</p>
                        <p class="due-date" id="due-date">Due Date: [Due Date]</p>
                    </div>
                    <div class="detail-item">
                        <h3>Group Members</h3>
                        <p id="group-members">[Group Members]</p>
                    </div>
                </div>
            </div>

            <div class="task-management">
                <h1>Team Task Management</h1>
                <button id="add-task-btn" type="button">Add New Task</button>
            </div>

            <div id="task-modal" class="modal">
                <div class="modal-content">
                    <span class="close-modal" id="close-modal">&times;</span>
                    <h2 id="modal-title">Add/Edit Task</h2>
                    <form id="task-form">
                        <div class="form-group">
                            <label for="task-title">Task Title</label>
                            <input type="text" id="task-title" name="task-title" required>
                        </div>
                        <div class="form-group">
                            <label for="task-desc">Task Description</label>
                            <textarea id="task-desc" name="task-desc" rows="4" required></textarea>
                        </div>
                        <div class="form-group">
                            <label for="assigned-member">Assigned Member</label>
                            <select id="assigned-member" name="assigned-member" required>
                                <!-- Dynamically populate options here -->
                            </select>
                        </div>
                        <div class="form-group">
                            <label for="due-date">Due Date</label>
                            <input type="date" id="due-date" name="due-date" required>
                        </div>
                        <div class="form-group">
                            <label for="task-status">Task Status</label>
                            <select id="task-status" name="task-status" required>
                                <!-- Dynamically populate status options here -->
                            </select>
                        </div>
                        <div class="form-actions">
                            <button type="submit" id="save-task-btn">Save Task</button>
                            <button type="button" id="cancel-task-btn">Cancel</button>
                        </div>
                    </form>
                </div>
            </div>


            <div class="task-columns">
                <div class="task-column" id="not-started-tasks">
                    <h2>Not Started (<span id="not-started-count">0</span>)</h2>
                    <!-- Dynamic Task Cards will be inserted here -->
                </div>

                <div class="task-column" id="in-progress-tasks">
                    <h2>In Progress (<span id="in-progress-count">0</span>)</h2>
                    <!-- Dynamic Task Cards will be inserted here -->
                </div>

                <div class="task-column" id="completed-tasks">
                    <h2>Completed (<span id="completed-count">0</span>)</h2>
                    <!-- Dynamic Task Cards will be inserted here -->
                </div>
            </div>



            <h1>Shared Files</h1>

            <div class="files-container">
                <h2>My Shared Files</h2>
                <!-- My Submissions Table -->
                <table id="my-shared-files-table">
                    <thead>
                        <tr>
                            <th>Task</th>
                            <th>File</th>
                            <th>Due Date</th>
                            <th>Status</th>
                        </tr>
                    </thead>
                    <tbody id="my-shared-files-body"></tbody>
                </table>
                <button class="upload-new">
                    <i class="fas fa-upload"></i>
                    Upload New File
                </button>
            </div>

            <div class="files-container">
                <h2>Group Shared Files</h2>
                <!-- Group Submissions Table -->
                <table id="group-shared-files-table">
                    <thead>
                        <tr>
                            <th>Submitted By</th>
                            <th>Task</th>
                            <th>File</th>
                            <th>Due Date</th>
                            <th>Status</th>
                        </tr>
                    </thead>
                    <tbody id="group-shared-files-body"></tbody>
                </table>
            </div>




        </section>




    </main>

    <div id="file-upload-modal" class="modal">
        <div class="modal-content">
            <span class="close-modal" id="close-file-upload-modal">&times;</span>
            <h2>Upload File</h2>
            <form id="file-upload-form">
                <div class="form-group">
                    <label for="task-select">Select Task</label>
                    <select id="task-select" name="taskId" required>
                        <option value="" disabled selected>Select a task</option>
                    </select>
                </div>
                <div class="form-group">
                    <label for="file-input">Choose File</label>
                    <input type="file" id="file-input" name="file" required />
                </div>
                <div class="form-actions">
                    <button type="submit" id="submit-file-btn">Submit</button>
                    <button type="button" id="cancel-file-upload-btn">Cancel</button>
                </div>
            </form>
        </div>
    </div>


    <script>

        // Global variables
        let currentGroupId = null;
        let currentUserRole = null; // Will be set to 'leader' or 'member'
        let currentTaskId = null; // For editing existing tasks
        document.addEventListener('DOMContentLoaded', async () => {
            // Check if the user is authenticated
            const token = localStorage.getItem('token');
            if (!token) {
                // Redirect to login only if no token exists
                window.location.href = '../../authentication/LoginPage.html';
                return;
            }

            try {
                // Get project ID from URL
                const urlParams = new URLSearchParams(window.location.search);
                const projectId = urlParams.get('id');

                if (!projectId) {
                    showNotification('Project ID not found in URL', 'error');
                    setTimeout(() => {
                        window.location.href = './ProjectList.html';
                    }, 1500);
                    return;
                }

                // Load user and project details
                await loadUserInfo(token);
                await loadProjectDetails(projectId, token);
                await fetchUserGroupAndRole(projectId, token);
                await loadTasks(token);
                await loadMySubmissions(projectId, token);


                // Use projectId and currentGroupId to load group submissions
                if (currentGroupId) {
                    await loadGroupSubmissions(projectId, currentGroupId, token);
                } else {
                    console.warn('No group ID found for the current user');
                    document.getElementById('group-shared-files-body').innerHTML = '<tr><td colspan="5">No group assigned</td></tr>';
                }

                // Set up event listeners
                setupTaskEventListeners(token);
                setupEventListeners(projectId, token);

            } catch (error) {
                console.error('Error loading page:', error);
                // Show user-friendly error message
                showNotification(`Error: ${error.message}`, 'error');
            }
        });

        // Function to fetch and display user info
        async function loadUserInfo(token) {
            try {
                const response = await fetch('http://localhost:5000/api/user', {
                    headers: {
                        'Authorization': `Bearer ${token}`
                    }
                });

                if (!response.ok) {
                    throw new Error('Failed to fetch user information');
                }

                const userData = await response.json();

                // Update user name in the sidebar
                if (userData.success && userData.data) {
                    document.getElementById('user-name').textContent = userData.data.username;
                } else {
                    document.getElementById('user-name').textContent = 'User';
                }
            } catch (error) {
                console.error('Error loading user info:', error);
                document.getElementById('user-name').textContent = 'User';
            }
        }

        async function loadProjectDetails(projectId, token) {
            try {
                // Fetch project details
                const projectResponse = await fetch(`http://localhost:5000/api/projects/${projectId}`, {
                    headers: {
                        'Authorization': `Bearer ${token}`
                    }
                });

                if (!projectResponse.ok) {
                    throw new Error('Failed to fetch project details');
                }

                const projectData = await projectResponse.json();

                // Populate project title and description
                document.getElementById('project-title').textContent = projectData.data.title;
                document.getElementById('project-description').textContent = projectData.data.description;

                // Format and display due date
                const dueDate = new Date(projectData.data.deadline);
                document.getElementById('due-date').textContent = `Due Date: ${dueDate.toLocaleDateString()}`;

                // Fetch group details for the logged-in user
                const groupDetails = await fetchUserGroup(projectId, token);

                // Inside loadProjectDetails function where we handle group display
                if (groupDetails) {
                    // Display group name - ensure we have a name to display
                    document.getElementById('assigned-group').textContent = groupDetails.name || 'Unnamed Group';

                    // Format team details with leader highlighted
                    let membersList = [];

                    // Add team leader if available
                    if (groupDetails.teamLeader) {
                        membersList.push(`${groupDetails.teamLeader} (Team Leader)`);
                    }

                    // Add other members
                    if (groupDetails.members && groupDetails.members.length > 0) {
                        // Filter out the team leader if they're also in the members list
                        const otherMembers = groupDetails.members.filter(member =>
                            member !== groupDetails.teamLeader);
                        membersList.push(...otherMembers);
                    }

                    document.getElementById('group-members').textContent =
                        membersList.length > 0 ? membersList.join(', ') : 'No members found';
                } else {
                    // Handle case where user is not assigned to any group
                    document.getElementById('assigned-group').textContent = 'No group assigned';
                    document.getElementById('group-members').textContent = 'N/A';
                }
                return true;

            } catch (error) {
                console.error('Failed to load project details:', error);
                showNotification(`Error: ${error.message}`, 'error');
                return false;
            }
        }

        async function fetchUserGroup(projectId, token) {
            try {
                const response = await fetch(`http://localhost:5000/api/projects/${projectId}/mygroup`, {
                    headers: {
                        'Authorization': `Bearer ${token}`
                    }
                });

                if (!response.ok) {
                    console.warn('Error fetching user group');
                    return null;
                }

                const result = await response.json();

                // Check if the response is successful and contains data
                if (result.success && result.data) {
                    return result.data;
                } else {
                    console.warn('No group data found for this user');
                    return null;
                }
            } catch (error) {
                console.error('Error fetching group details:', error);
                return null;
            }
        }

        function updateAssignedMemberOptions(groupDetails) {
            const assignedMemberSelect = document.getElementById('assigned-member');
            if (!assignedMemberSelect) return; // Exit if element doesn't exist

            // Clear existing options
            assignedMemberSelect.innerHTML = '<option value="" disabled selected>Select a member</option>';

            // Add team leader as the first option
            if (groupDetails.teamLeader) {
                const leaderOption = document.createElement('option');
                leaderOption.value = groupDetails.teamLeader;
                leaderOption.textContent = `${groupDetails.teamLeader} (Team Leader)`;
                assignedMemberSelect.appendChild(leaderOption);
            }

            // Add other members as options
            if (groupDetails.members && groupDetails.members.length > 0) {
                groupDetails.members.forEach(member => {
                    // Skip if this is the team leader (already added)
                    if (member !== groupDetails.teamLeader) {
                        const memberOption = document.createElement('option');
                        memberOption.value = member;
                        memberOption.textContent = member;
                        assignedMemberSelect.appendChild(memberOption);
                    }
                });
            }
        }


        async function fetchUserGroupAndRole(projectId, token) {
            try {
                const response = await fetch(`http://localhost:5000/api/projects/${projectId}/mygroup`, {
                    headers: {
                        'Authorization': `Bearer ${token}`
                    }
                });

                if (!response.ok) {
                    throw new Error('Failed to fetch group details');
                }

                const result = await response.json();
                console.log('Group API response:', result);

                if (result.success && result.data) {
                    const group = result.data;
                    currentGroupId = group.id;

                    // Check if current user is the team leader
                    const currentUser = document.getElementById('user-name').textContent;
                    if (group.teamLeader === currentUser) {
                        currentUserRole = 'leader';
                        document.getElementById('add-task-btn').style.display = 'block';
                    } else {
                        currentUserRole = 'member';
                        document.getElementById('add-task-btn').style.display = 'none';
                    }

                    // We need to fetch the actual group members with their IDs
                    const membersResponse = await fetch(`http://localhost:5000/api/groups/${group.id}/members`, {
                        headers: {
                            'Authorization': `Bearer ${token}`
                        }
                    });

                    if (membersResponse.ok) {
                        const membersData = await membersResponse.json();
                        console.log('Group members data:', membersData);

                        if (membersData.success && membersData.data) {
                            // Add member data to the group object
                            group.memberDetails = membersData.data;

                            // Now populate the dropdown with the correct IDs
                            updateAssignedMemberOptions(group);
                        }
                    }

                    return group;
                } else {
                    throw new Error('No group found or user not in a group');
                }
            } catch (error) {
                console.error('Error fetching group and role:', error);
                showNotification(`Error: ${error.message}`, 'error');
                return null;
            }
        }

        // Load tasks for the current group
        async function loadTasks(token) {
            if (!currentGroupId) {
                showNotification('No group found', 'error');
                return;
            }

            try {
                const response = await fetch(`http://localhost:5000/api/groups/${currentGroupId}/tasks`, {
                    headers: {
                        'Authorization': `Bearer ${token}`
                    }
                });

                if (!response.ok) {
                    throw new Error('Failed to fetch tasks');
                }

                const result = await response.json();

                if (result.success && result.data) {
                    displayTasks(result.data);
                } else {
                    showNotification('No tasks found for this group', 'info');
                }
            } catch (error) {
                console.error('Error loading tasks:', error);
                showNotification(`Error: ${error.message}`, 'error');
            }
        }

        function displayTasks(tasks) {
            // Clear existing tasks
            document.getElementById('not-started-tasks').innerHTML = '<h2>Not Started (<span id="not-started-count">0</span>)</h2>';
            document.getElementById('in-progress-tasks').innerHTML = '<h2>In Progress (<span id="in-progress-count">0</span>)</h2>';
            document.getElementById('completed-tasks').innerHTML = '<h2>Completed (<span id="completed-count">0</span>)</h2>';

            // Count tasks in each category
            let notStartedCount = 0;
            let inProgressCount = 0;
            let completedCount = 0;

            tasks.forEach(task => {
                const taskCard = createTaskCard(task);

                // Make sure we're using the correct status values from the backend
                const status = task.status ? task.status.toLowerCase() : 'pending';

                switch (status) {
                    case 'in_progress':
                        document.getElementById('in-progress-tasks').appendChild(taskCard);
                        inProgressCount++;
                        break;
                    case 'completed':
                        document.getElementById('completed-tasks').appendChild(taskCard);
                        completedCount++;
                        break;
                    case 'pending':
                    default:
                        document.getElementById('not-started-tasks').appendChild(taskCard);
                        notStartedCount++;
                        break;
                }
            });

            // Update counters
            document.getElementById('not-started-count').textContent = notStartedCount;
            document.getElementById('in-progress-count').textContent = inProgressCount;
            document.getElementById('completed-count').textContent = completedCount;
        }

        function createTaskCard(task) {
            const card = document.createElement('div');

            // Map backend status values to CSS class names
            let statusClass;
            switch (task.status) {
                case 'in_progress':
                    statusClass = 'inprogress';
                    break;
                case 'completed':
                    statusClass = 'completed';
                    break;
                case 'pending':
                default:
                    statusClass = 'pending';
                    break;
            }

            card.className = `task-card status-${statusClass}`;
            card.dataset.taskId = task.id;
            card.dataset.status = task.status || 'pending';

            const dueDate = new Date(task.dueDate);
            const formattedDate = dueDate.toLocaleDateString();

            let statusText = "";
            switch (task.status) {
                case 'in_progress':
                    statusText = "In Progress";
                    break;
                case 'completed':
                    statusText = "Completed";
                    break;
                case 'pending':
                default:
                    statusText = "Not Started";
                    break;
            }

            card.innerHTML = `
                <h3>${task.title}</h3>
                <p>${task.description}</p>
                <div class="task-meta">
                    <span class="assignee">Assigned to: ${task.assignedTo ? task.assignedTo.username : 'Unassigned'}</span>
                    <div class="task-details">
                         <span class="due-date">Due: ${formattedDate}</span>
                    <span class="task-status">${statusText}</span>
                    </div>
                    
                </div>
                ${currentUserRole === 'leader' ? `
                <div class="task-actions">
                    <button class="edit-task-btn" data-task-id="${task.id}">Edit</button>
                    <button class="delete-task-btn" data-task-id="${task.id}">Delete</button>
                </div>
                ` : ''}
            `;

            return card;
        }

        // Set up event listeners for task management
        function setupTaskEventListeners(token) {
            const modal = document.getElementById('task-modal');
            const addTaskBtn = document.getElementById('add-task-btn');
            const closeModalBtn = document.getElementById('close-modal');
            const cancelTaskBtn = document.getElementById('cancel-task-btn');
            const taskForm = document.getElementById('task-form');
            const dueDateField = document.getElementById('due-date');


            // Populate status options
            const statusSelect = document.getElementById('task-status');
            statusSelect.innerHTML = `
        <option value="not-started">Not Started</option>
        <option value="in_progress">In Progress</option>
        <option value="completed">Completed</option>
        
    `;
            // Add event listener to the status dropdown
            statusSelect.addEventListener('change', () => {
                if (statusSelect.value === 'completed') {
                    // Hide the due date field when status is "Completed"
                    dueDateField.style.display = 'block';
                    dueDateInput.removeAttribute('required');
                } else {
                    // Show the due date field for other statuses
                    dueDateField.style.display = 'block';
                    dueDateInput.setAttribute('required', 'required');
                }
            });
            // Open modal for adding a new task
            addTaskBtn.addEventListener('click', () => {
                document.getElementById('modal-title').textContent = 'Add New Task';
                resetTaskForm();
                currentTaskId = null;
                modal.style.display = 'block';
            });

            // Close modal
            closeModalBtn.addEventListener('click', () => {
                modal.style.display = 'none';
            });

            cancelTaskBtn.addEventListener('click', () => {
                modal.style.display = 'none';
            });

            // Close modal when clicking outside
            window.addEventListener('click', (event) => {
                if (event.target === modal) {
                    modal.style.display = 'none';
                }
            });

            // Handle form submission (create or update task)
            taskForm.addEventListener('submit', async (event) => {
                event.preventDefault();

                const taskTitle = document.getElementById('task-title').value;
                const taskDesc = document.getElementById('task-desc').value;
                const assignedMember = document.getElementById('assigned-member').value;
                const taskStatus = document.getElementById('task-status').value;


                // Only include due date if the status is not "Completed"
                const dueDate = taskStatus === 'completed' ? null : document.getElementById('due-date').value;

                // Validate due date only if the status is not "Completed"
                if (taskStatus !== 'completed') {
                    const selectedDate = new Date(dueDate);
                    const currentDate = new Date();
                    currentDate.setHours(0, 0, 0, 0); // Set time to midnight for comparison

                    if (selectedDate < currentDate) {
                        showNotification('Due date cannot be in the past. Please select a valid date.', 'error');
                        return;
                    }
                }

                try {
                    let url, method;

                    if (currentTaskId) {
                        // Update existing task
                        url = `http://localhost:5000/api/groups/${currentGroupId}/tasks/${currentTaskId}`;
                        method = 'PUT';
                    } else {
                        // Create new task
                        url = `http://localhost:5000/api/groups/${currentGroupId}/tasks`;
                        method = 'POST';
                    }

                    const response = await fetch(url, {
                        method: method,
                        headers: {
                            'Authorization': `Bearer ${token}`,
                            'Content-Type': 'application/json'
                        },
                        body: JSON.stringify({
                            title: taskTitle,
                            description: taskDesc,
                            assignedToId: assignedMember,
                            dueDate: dueDate,
                            status: taskStatus
                        })
                    });

                    // Check if the response is not JSON
                    const contentType = response.headers.get('content-type');
                    if (!response.ok || !contentType || !contentType.includes('application/json')) {
                        const errorText = await response.text(); // Get the raw response text
                        throw new Error(`Unexpected response: ${errorText}`);
                    }

                    const result = await response.json();
                    // Refresh tasks
                    await loadTasks(token);

                    // Close modal
                    modal.style.display = 'none';

                    // Show success notification
                    showNotification(currentTaskId ? 'Task updated successfully' : 'Task created successfully', 'success');

                } catch (error) {
                    console.error('Error saving task:', error);
                    showNotification(`Error: ${error.message}`, 'error');
                }
            });

            // Event delegation for edit and delete buttons
            document.addEventListener('click', async (event) => {
                // Edit task
                if (event.target.classList.contains('edit-task-btn')) {
                    const taskId = event.target.dataset.taskId;
                    await openEditTaskModal(taskId, token);
                }

                // Delete task
                if (event.target.classList.contains('delete-task-btn')) {
                    const taskId = event.target.dataset.taskId;
                    await deleteTask(taskId, token);
                }
            });
        }

        // Open modal for editing a task
        async function openEditTaskModal(taskId, token) {
            try {
                const response = await fetch(`http://localhost:5000/api/groups/${currentGroupId}/tasks`, {
                    headers: {
                        'Authorization': `Bearer ${token}`
                    }
                });

                if (!response.ok) {
                    throw new Error('Failed to fetch task details');
                }

                const result = await response.json();
                const task = result.data.find(t => t.id == taskId);

                if (!task) {
                    throw new Error('Task not found');
                }

                // Set form values
                document.getElementById('modal-title').textContent = 'Edit Task';
                document.getElementById('task-title').value = task.title;
                document.getElementById('task-desc').value = task.description;
                document.getElementById('assigned-member').value = task.assignedToId;

                // Format date for input
                const dueDate = new Date(task.dueDate);
                const formattedDate = dueDate.toISOString().split('T')[0];
                document.getElementById('due-date').value = formattedDate;

                document.getElementById('task-status').value = task.status || 'not-started';

                // Set current task ID for the form
                currentTaskId = taskId;

                // Open modal
                document.getElementById('task-modal').style.display = 'block';

            } catch (error) {
                console.error('Error opening edit modal:', error);
                showNotification(`Error: ${error.message}`, 'error');
            }
        }

        // Delete a task
        async function deleteTask(taskId, token) {
            if (!confirm('Are you sure you want to delete this task?')) {
                return;
            }

            try {
                const response = await fetch(`http://localhost:5000/api/groups/${currentGroupId}/tasks/${taskId}`, {
                    method: 'DELETE',
                    headers: {
                        'Authorization': `Bearer ${token}`
                    }
                });

                if (!response.ok) {
                    const errorData = await response.json();
                    throw new Error(errorData.message || 'Failed to delete task');
                }

                // Refresh tasks
                await loadTasks(token);

                // Show success notification
                showNotification('Task deleted successfully', 'success');

            } catch (error) {
                console.error('Error deleting task:', error);
                showNotification(`Error: ${error.message}`, 'error');
            }
        }

        // Reset task form
        function resetTaskForm() {
            document.getElementById('task-title').value = '';
            document.getElementById('task-desc').value = '';
            document.getElementById('assigned-member').selectedIndex = 0;
            document.getElementById('task-status').value = 'not-started';

            // Set due date to tomorrow by default
            const tomorrow = new Date();
            tomorrow.setDate(tomorrow.getDate() + 1);
            const formattedDate = tomorrow.toISOString().split('T')[0];
            document.getElementById('due-date').value = formattedDate;

            // Ensure the due date field is visible and required
            const dueDateField = dueDateInput.parentElement;
            dueDateField.style.display = 'block';
            dueDateInput.setAttribute('required', 'required');
        }

        function updateAssignedMemberOptions(groupDetails) {
            const assignedMemberSelect = document.getElementById('assigned-member');
            if (!assignedMemberSelect) return;

            // Clear existing options
            assignedMemberSelect.innerHTML = '<option value="" disabled selected>Select a member</option>';

            console.log('Updating member options with:', groupDetails);

            // Use the memberDetails array that contains the full user objects
            if (groupDetails.memberDetails && groupDetails.memberDetails.length > 0) {
                groupDetails.memberDetails.forEach(member => {
                    const option = document.createElement('option');
                    option.value = member.userId; // This is the critical part - use userId

                    // Mark the team leader
                    const isLeader = member.userId === groupDetails.teamLeaderId;
                    option.textContent = isLeader ?
                        `${member.username} (Team Leader)` : member.username;

                    assignedMemberSelect.appendChild(option);
                    console.log('Added member option:', option.value, option.textContent);
                });
            } else {
                // Fallback if we don't have memberDetails
                console.warn('No member details available');
            }
        }


        // Show notification
        function showNotification(message, type) {
            // You can implement this based on your notification system
            console.log(`${type}: ${message}`);
            alert(message);
        }

        function setupEventListeners(projectId, token) {
            // Back button event listener
            const backButton = document.getElementById('back-btn');
            backButton.addEventListener('click', () => {
                window.location.href = './ProjectList.html';
            });

            // Logout button event listener
            const logoutButton = document.querySelector('.sidebar-logout-button');
            if (logoutButton) {
                logoutButton.addEventListener('click', () => {
                    localStorage.removeItem('token');
                    window.location.href = '../../authentication/LoginPage.html';
                });
            }
        }




        // File Upload Modal Elements
        const fileUploadModal = document.getElementById('file-upload-modal');
        const openFileUploadModalBtn = document.querySelector('.upload-new');
        const closeFileUploadModalBtn = document.getElementById('close-file-upload-modal');
        const cancelFileUploadBtn = document.getElementById('cancel-file-upload-btn');
        const fileUploadForm = document.getElementById('file-upload-form');
        const taskSelect = document.getElementById('task-select');
        const fileInput = document.getElementById('file-input');

        // Open the file upload modal
        openFileUploadModalBtn.addEventListener('click', async () => {
            // Populate the task dropdown
            await populateTaskDropdown();
            fileUploadModal.style.display = 'flex';
        });

        // Close the file upload modal
        closeFileUploadModalBtn.addEventListener('click', () => {
            fileUploadModal.style.display = 'none';
        });

        cancelFileUploadBtn.addEventListener('click', () => {
            fileUploadModal.style.display = 'none';
        });

        // Close modal when clicking outside
        window.addEventListener('click', (e) => {
            if (e.target === fileUploadModal) {
                fileUploadModal.style.display = 'none';
            }
        });

        // Populate the task dropdown
        async function populateTaskDropdown() {
            try {
                const token = localStorage.getItem('token');
                const response = await fetch(`http://localhost:5000/api/groups/${currentGroupId}/tasks`, {
                    headers: {
                        'Authorization': `Bearer ${token}`
                    }
                });

                if (!response.ok) {
                    throw new Error('Failed to fetch tasks');
                }

                const result = await response.json();

                if (result.success && result.data) {
                    taskSelect.innerHTML = '<option value="" disabled selected>Select a task</option>';
                    result.data.forEach(task => {
                        const option = document.createElement('option');
                        option.value = task.id;
                        option.textContent = task.title;
                        taskSelect.appendChild(option);
                    });
                } else {
                    taskSelect.innerHTML = '<option value="" disabled>No tasks available</option>';
                }
            } catch (error) {
                console.error('Error populating task dropdown:', error);
                taskSelect.innerHTML = '<option value="" disabled>Error loading tasks</option>';
            }
        }

        // Handle file upload form submission
        fileUploadForm.addEventListener('submit', async (e) => {
            e.preventDefault();

            const token = localStorage.getItem('token');
            const formData = new FormData(fileUploadForm);
            const file = fileInput.files[0];

            // Validate file type
            const allowedExtensions = ['txt', 'pdf'];
            const fileExtension = file.name.split('.').pop().toLowerCase();

            if (!allowedExtensions.includes(fileExtension)) {
                alert('Invalid file type. Only .txt and .pdf files are allowed.');
                return;
            }

            try {
                const response = await fetch(`http://localhost:5000/api/tasks/${formData.get('taskId')}/submissions`, {
                    method: 'POST',
                    headers: {
                        'Authorization': `Bearer ${token}`
                    },
                    body: formData
                });

                if (!response.ok) {
                    const errorData = await response.json();
                    throw new Error(errorData.message || 'Failed to submit file');
                }

                const result = await response.json();
                alert('File submitted successfully!');
                fileUploadModal.style.display = 'none';

                // Refresh the submissions table
                const projectId = new URLSearchParams(window.location.search).get('id');
                await loadMySubmissions(projectId, token);
            } catch (error) {
                console.error('Error submitting file:', error);
                alert(`Error: ${error.message}`);
            }
        });

        // Load the current user's submissions for a project
        async function loadMySubmissions(projectId, token) {

            try {
                // Fetch submissions from the backend
                const response = await fetch(`http://localhost:5000/api/projects/${projectId}/submissions`, {
                    headers: {
                        'Authorization': `Bearer ${token}`
                    }
                });

                if (!response.ok) {
                    const errorData = await response.json();
                    console.error('Backend error:', errorData);
                    throw new Error(errorData.message || 'Failed to fetch your submissions');
                }

                const result = await response.json();

                if (result.success && result.submissions) {
                    // Populate the table with user's submissions
                    const submissionsBody = document.getElementById('my-shared-files-body');
                    submissionsBody.innerHTML = ''; // Clear existing rows

                    result.submissions.forEach(submission => {
                        const row = document.createElement('tr');

                        // Check if the submission is late
                        const submissionDate = new Date(submission.submissionTime);
                        const dueDate = new Date(submission.dueDate);
                        const isLate = submissionDate > dueDate;

                        // Update the status to include "late" if applicable
                        let statusText = submission.status;
                        if (isLate) {
                            statusText += ' <span class="late-text">(late)</span>';
                        }

                        // Extract just the filename from the path
                        // This will work for both full paths and relative paths
                        const fullPath = submission.sharedFile;
                        const fileName = fullPath.split('\\').pop().split('/').pop();

                        row.innerHTML = `
                    <td>${submission.task}</td>
                    <td>
                        <a href="http://localhost:5000/api/submissions/${submission.id}/download" class="file-link" target="_blank">
                            <i class="fas fa-file"></i> ${fileName}
                        </a>
                    </td>
                    <td>${dueDate.toLocaleDateString()}</td>
                    <td>
                        <span class="status ${submission.status.toLowerCase()}">${statusText}</span>
                    </td>
                `;

                        submissionsBody.appendChild(row);
                    });
                } else {
                    console.warn('No submissions found');
                    document.getElementById('my-shared-files-body').innerHTML = '<tr><td colspan="4">No submissions found</td></tr>';
                }
            } catch (error) {
                console.error('Error loading your submissions:', error);
                document.getElementById('my-shared-files-body').innerHTML = '<tr><td colspan="4">Failed to load submissions</td></tr>';
            }
        }


        // Load group submissions
        async function loadGroupSubmissions(projectId, groupId, token) {
            try {
                // Fetch submissions from the backend
                const response = await fetch(`http://localhost:5000/api/projects/${projectId}/groups/${groupId}/submissions`, {
                    headers: {
                        'Authorization': `Bearer ${token}`
                    }
                });

                if (!response.ok) {
                    const errorData = await response.json();
                    console.error('Backend error:', errorData);
                    throw new Error(errorData.message || 'Failed to fetch group submissions');
                }

                const result = await response.json();

                if (result.success && result.data) {
                    // Populate the table with submissions
                    const submissionsBody = document.getElementById('group-shared-files-body');
                    submissionsBody.innerHTML = ''; // Clear existing rows

                    result.data.forEach(submission => {
                        const row = document.createElement('tr');

                        // Check if the submission is late
                        const submissionDate = new Date(submission.submissionTime);
                        const dueDate = new Date(submission.Task.dueDate);
                        const isLate = submissionDate > dueDate;

                        // Update the status to include "late" if applicable
                        let statusText = submission.status;
                        if (isLate) {
                            statusText += ' <span class="late-text">(late)</span>';
                        }

                        row.innerHTML = `
                            <td>${submission.submitter ? submission.submitter.username : 'Unknown'}</td>
                            <td>${submission.Task.title}</td>
                            <td>
                                <a href="http://localhost:5000/api/submissions/${submission.id}/download" class="file-link" target="_blank">
                                    <i class="fas fa-file"></i> ${submission.fileName}
                                </a>
                            </td>
                            <td>${dueDate.toLocaleDateString()}</td>
                            <td>
                                <span class="status ${submission.status.toLowerCase()}">${statusText} </span>
                            </td>
                        `;

                        submissionsBody.appendChild(row);
                    });
                } else {
                    console.warn('No submissions found');
                    document.getElementById('group-shared-files-body').innerHTML = '<tr><td colspan="5">No submissions found</td></tr>';
                }
            } catch (error) {
                console.error('Error loading group submissions:', error);
                document.getElementById('group-shared-files-body').innerHTML = '<tr><td colspan="5">Failed to load submissions</td></tr>';
            }
        }

        
        // Sidebar Toggle Functionality
        const mobileMenuToggle = document.getElementById('mobile-menu-toggle');
        const sidebar = document.getElementById('sidebar');
        const toggleSidebar = document.getElementById('toggle-sidebar');
        const toggleIcon = document.getElementById('toggle-icon');

        // Mobile Menu Toggle
        mobileMenuToggle.addEventListener('click', () => {
            sidebar.classList.toggle('open');
        });

        // Desktop Collapse Toggle
        const handleSidebarToggle = () => {
            sidebar.classList.toggle('collapsed');

            if (sidebar.classList.contains('collapsed')) {
                toggleIcon.classList.replace('fa-chevron-left', 'fa-chevron-right');
                document.querySelector('section').style.marginLeft = '10px';
                document.querySelector('section').style.maxWidth = 'calc(100% - 70px)';
            } else {
                toggleIcon.classList.replace('fa-chevron-right', 'fa-chevron-left');
                document.querySelector('section').style.marginLeft = '20px';
                document.querySelector('section').style.maxWidth = 'calc(100% - 270px)';
            }
        };

        // Window Resize Handler
        const handleResize = () => {
            if (window.innerWidth > 768) {
                sidebar.classList.remove('open');
                toggleSidebar.style.display = 'block';
            } else {
                toggleSidebar.style.display = 'none';
            }
        };

        // Event Listeners
        toggleSidebar.addEventListener('click', handleSidebarToggle);
        window.addEventListener('resize', handleResize);
        document.addEventListener('DOMContentLoaded', handleResize);

        // Close sidebar when clicking outside on mobile
        document.addEventListener('click', (e) => {
            if (window.innerWidth <= 768 &&
                !sidebar.contains(e.target) &&
                e.target !== mobileMenuToggle &&
                sidebar.classList.contains('open')) {
                sidebar.classList.remove('open');
            }


        });

        // Modal Functionality
        const taskModal = document.getElementById('task-modal');
        const addTaskBtn = document.getElementById('add-task-btn');
        const closeModal = document.getElementById('close-modal');
        const cancelTaskBtn = document.getElementById('cancel-task-btn');
        const modalTitle = document.getElementById('modal-title');


        // Open modal for adding new task
        addTaskBtn.addEventListener('click', () => {
            modalTitle.textContent = 'Add New Task';
            taskModal.style.display = 'flex';
        });

        // Close modal
        closeModal.addEventListener('click', () => {
            taskModal.style.display = 'none';
        });

        cancelTaskBtn.addEventListener('click', () => {
            taskModal.style.display = 'none';
        });

        // Close modal when clicking outside
        window.addEventListener('click', (e) => {
            if (e.target === taskModal) {
                taskModal.style.display = 'none';
            }
        });
    </script>
</body>

</html>